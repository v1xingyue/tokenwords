name: Deploy program to Solana testnet

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      program_id:
        description: "Optional existing program ID to upgrade"
        required: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      SOLANA_VERSION: "1.18.24"
      SOLANA_DEPLOY_KEYPAIR: ${{ secrets.SOLANA_DEPLOY_KEYPAIR }}
      SOLANA_RPC_URL: ${{ secrets.SOLANA_RPC_URL }}
    steps:
      - name: Check required secrets
        id: secret_guard
        run: |
          missing=""
          for var in SOLANA_DEPLOY_KEYPAIR SOLANA_RPC_URL; do
            if [ -z "${!var}" ]; then
              missing+="$var "
            fi
          done

          if [ -n "$missing" ]; then
            echo "secrets_present=false" >> "$GITHUB_OUTPUT"
            echo "Missing secrets: $missing" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "secrets_present=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Abort when secrets are absent
        if: steps.secret_guard.outputs.secrets_present != 'true'
        run: echo "Skipping deployment because required secrets are not configured."

      - name: Checkout repository
        if: steps.secret_guard.outputs.secrets_present == 'true'
        uses: actions/checkout@v4

      - name: Install Solana CLI
        if: steps.secret_guard.outputs.secrets_present == 'true'
        run: |
          curl -sSfL "https://release.solana.com/v${SOLANA_VERSION}/install" -o /tmp/solana-install.sh
          bash /tmp/solana-install.sh
          echo "$HOME/.local/share/solana/install/active_release/bin" >> "$GITHUB_PATH"

      - name: Verify Solana install
        if: steps.secret_guard.outputs.secrets_present == 'true'
        run: solana --version

      - name: Write deploy keypair
        if: steps.secret_guard.outputs.secrets_present == 'true'
        run: |
          KEYPAIR_PATH=deploy-keypair.json
          if [ -n "$SOLANA_DEPLOY_KEYPAIR" ]; then
            echo "$SOLANA_DEPLOY_KEYPAIR" | base64 --decode > "$KEYPAIR_PATH"
            echo "Using provided deploy keypair secret." >> "$GITHUB_STEP_SUMMARY"
          else
            if [ ! -f "$KEYPAIR_PATH" ]; then
              echo "Repository deploy keypair missing at $KEYPAIR_PATH" >&2
              exit 1
            fi
            echo "No deploy keypair secret set; using repository keypair at $KEYPAIR_PATH." >> "$GITHUB_STEP_SUMMARY"
          fi
          chmod 600 "$KEYPAIR_PATH"
          DEPLOY_PUBKEY=$(solana-keygen pubkey "$KEYPAIR_PATH")
          echo "DEPLOY_PUBKEY=$DEPLOY_PUBKEY" >> "$GITHUB_ENV"
          echo "Deploy keypair pubkey: $DEPLOY_PUBKEY" >> "$GITHUB_STEP_SUMMARY"

      - name: Resolve RPC endpoint
        if: steps.secret_guard.outputs.secrets_present == 'true'
        run: |
          RPC_URL="${SOLANA_RPC_URL:-https://api.testnet.solana.com}"
          echo "RPC_URL=$RPC_URL" >> $GITHUB_ENV
          solana config set --url "$RPC_URL"
          solana config set --keypair ./deploy-keypair.json

      - name: Fund deployer with test SOL
        run: |
          MIN_BALANCE=1
          get_balance() {
            solana balance "$DEPLOY_PUBKEY" --url "$RPC_URL" --commitment confirmed 2>/dev/null | awk '{print $1}'
          }

          CURRENT_BALANCE=$(get_balance)
          if [ -n "$CURRENT_BALANCE" ] && awk "BEGIN {exit !($CURRENT_BALANCE >= MIN_BALANCE)}"; then
            echo "Deployer already funded with ${CURRENT_BALANCE} SOL." >> "$GITHUB_STEP_SUMMARY"
            exit 0
          fi

          ATTEMPTS=0
          while [ $ATTEMPTS -lt 3 ]; do
            if solana airdrop 2 "$DEPLOY_PUBKEY" --url "$RPC_URL" --commitment confirmed; then
              CURRENT_BALANCE=$(get_balance)
              if [ -n "$CURRENT_BALANCE" ] && awk "BEGIN {exit !($CURRENT_BALANCE >= MIN_BALANCE)}"; then
                echo "Funded deployer to ${CURRENT_BALANCE} SOL." >> "$GITHUB_STEP_SUMMARY"
                exit 0
              fi
            fi

            ATTEMPTS=$((ATTEMPTS+1))
            echo "Airdrop attempt $ATTEMPTS failed or balance still low; retrying in 5s..."
            sleep 5
          done

          echo "Insufficient SOL for deployment. Fund $DEPLOY_PUBKEY and rerun the workflow." | tee -a "$GITHUB_STEP_SUMMARY"
          exit 1

      - name: Build program shared object
        if: steps.secret_guard.outputs.secrets_present == 'true'
        run: ./scripts/build-so.sh

      - name: Locate compiled program artifact
        if: steps.secret_guard.outputs.secrets_present == 'true'
        run: |
          PROGRAM_SO=$(find target -name predict_chat_program.so | head -n 1)
          if [ -z "$PROGRAM_SO" ]; then
            echo "predict_chat_program.so not found" >&2
            exit 1
          fi
          echo "PROGRAM_SO=$PROGRAM_SO" >> $GITHUB_ENV

      - name: Deploy to testnet
        if: steps.secret_guard.outputs.secrets_present == 'true'
        env:
          PROGRAM_ID_INPUT: ${{ github.event.inputs.program_id }}
        run: |
          EXTRA_ARGS=""
          if [ -n "$PROGRAM_ID_INPUT" ]; then
            EXTRA_ARGS="--program-id $PROGRAM_ID_INPUT"
          fi
          solana program deploy $EXTRA_ARGS "$PROGRAM_SO"
